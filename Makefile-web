# This can be overridden on cmdline to generate pages elsewhere.
WEBDIR=/home/rusty/www/html/ccan

# Ignore EXCLUDE when making webpages.
REALLY_ALL=$(patsubst ccan/%/_info, %, $(shell bzr ls -R ccan | grep '/_info$$'))
ALL_PAGES=$(patsubst %, $(WEBDIR)/info/%.html, $(REALLY_ALL))
DIRECT_TARBALLS=$(patsubst %, $(WEBDIR)/tarballs/%.tar.bz2, $(REALLY_ALL))
DEPEND_TARBALLS=$(patsubst %, $(WEBDIR)/tarballs/with-deps/%.tar.bz2, $(REALLY_ALL))
WEB_SUBDIRS=$(WEBDIR)/tarballs $(WEBDIR)/junkcode $(WEBDIR)/tarballs/with-deps $(WEBDIR)/info
JUNKDIRS=$(wildcard junkcode/*)
JUNKPAGES=$(JUNKDIRS:%=$(WEBDIR)/%.html)
JUNKBALLS=$(JUNKDIRS:%=$(WEBDIR)/%.tar.bz2)
BZRBROWSE=$(WEBDIR)/bzrbrowse.cgi $(WEBDIR)/file.png $(WEBDIR)/folder.png $(WEBDIR)/symlink.png

upload: fastcheck webpages
	bzr push
	send-web # Rusty's upload script.

webpages: $(WEB_SUBDIRS) $(WEBDIR)/index.html $(WEBDIR)/upload.html $(WEBDIR)/uploader.php $(WEBDIR)/example-config.h $(WEBDIR)/ccan.jpg $(BZRBROWSE) $(DIRECT_TARBALLS) $(DEPEND_TARBALLS) $(WEBDIR)/ccan.tar.bz2 $(WEBDIR)/Makefile-ccan $(ALL_PAGES) junkpages

junkpages:  $(WEBDIR)/list.html $(WEBDIR)/junkcode $(JUNKPAGES) $(JUNKBALLS)
$(WEB_SUBDIRS):
	mkdir -p $@

$(WEBDIR)/junkcode/%.tar.bz2: junkcode/% $(WEBDIR)/junkcode
	(bzr ls --recursive --versioned --kind=file --null $<; bzr ls --recursive --versioned --kind=symlink --null $<) | xargs -0 -x tar cvfj $@ 

$(WEBDIR)/junkcode/%.html: $(WEBDIR)/junkcode/%.tar.bz2
	cd $(WEBDIR) && tar xfj junkcode/$*.tar.bz2
	php5 web/staticjunkcode.php junkcode/$* $* > $@

# We want tarball to contain ccan/
$(WEBDIR)/ccan.tar.bz2: config.h Makefile Makefile-ccan $(shell bzr ls --versioned --kind=file --recursive ccan) $(shell bzr ls --versioned --recursive --kind=file tools) $(shell bzr ls --versioned --kind=symlink --recursive ccan) $(shell bzr ls --versioned --recursive --kind=symlink tools)
	DIR=`pwd` && cd /tmp && ln -sf "$$DIR" ccan && tar cvfj $@ `for f in $^; do echo ccan/$$f; done` && rm ccan

$(ALL_PAGES): tools/doc_extract web/staticmoduleinfo.php

$(WEBDIR)/list.html: web/staticall.php tools/doc_extract $(DIRECT_TARBALLS) $(DEPEND_TARBALLS) $(WEBDIR)/ccan.tar.bz2 $(JUNKBALLS)
	php5 web/staticall.php ccan/ junkcode/ $(WEBDIR) > $@

$(WEBDIR)/upload.html: web/staticupload.php
	php5 web/staticupload.php > $@

# cpp inserts gratuitous linebreaks at start of file, makes for php problems.
$(WEBDIR)/uploader.php: web/uploader.php.cpp
	cpp -w -C -P $< | grep . > $@

$(WEBDIR)/index.html: web/staticindex.php
	php5 web/staticindex.php > $@

$(WEBDIR)/example-config.h: config.h
	cp $< $@

$(WEBDIR)/Makefile-ccan: Makefile-ccan
	cp $< $@

$(WEBDIR)/ccan.jpg: web/ccan.jpg
	cp $< $@

$(BZRBROWSE): $(WEBDIR)/%: web/bzrbrowse/%
	cp $< $@

$(WEBDIR)/info/%.html: $(WEBDIR)/tarballs/%.tar.bz2 $(WEBDIR)/tarballs/with-deps/%.tar.bz2
	URLPREFIX=../ php5 web/staticmoduleinfo.php `pwd`/ccan/$* > $@

$(WEBDIR)/tarballs/%.tar.bz2: ccan/%/_info
	tar -c -j -f $@ `bzr ls --recursive --versioned --kind=file ccan/$*` `bzr ls --recursive --versioned --kind=symlink ccan/$*` $$(for l in $$(bzr ls --recursive --versioned --kind=symlink ccan/$* | xargs -r ls -l | sed 's,.*/,,'); do echo licences/$$l; done | sort -u)

$(WEBDIR)/tarballs/with-deps/%.tar.bz2: ccan/%/_info tools/ccan_depends
	tar cfj $@ $$(echo ccan/$* $$(tools/ccan_depends ccan/$*) | xargs -n 1 bzr ls --recursive --versioned --kind=file) $$(echo ccan/$* $$(tools/ccan_depends ccan/$*) | xargs -n 1 bzr ls --recursive --versioned --kind=symlink) $$(for l in $$(echo ccan/$* $$(tools/ccan_depends ccan/$*) | xargs -r -n 1 bzr ls --recursive --versioned --kind=symlink | xargs -r ls -l | sed 's,.*/,,'); do echo licences/$$l; done | sort -u)

distclean: distclean-web

distclean-web:
	rm -rf $(WEBDIR)
